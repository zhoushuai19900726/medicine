<!DOCTYPE html>
<html lang="en" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/layui2.0/lib/layui-v2.6.3/css/layui.css}" media="all">
    <link rel="stylesheet" th:href="@{/layui2.0/lib/font-awesome-4.7.0/css/font-awesome.min.css}" media="all">
    <link rel="stylesheet" th:href="@{/layui2.0/css/public.css}" media="all">
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main" shiro:hasPermission="goods:add">

        <div class="layui-carousel" id="stepForm" lay-filter="stepForm" style="margin: 0 auto;">
            <div carousel-item>
                <div>
                    <form class="layui-form" style="margin: 0 auto;">
                        <blockquote class="layui-elem-quote">
                            <i class="layui-icon">&#xe653;</i> 选择商品分类
                            <span class="layui-breadcrumb" lay-separator="<i class='layui-icon'>&#xe602;</i>" style="float: right;">
                                <a href="javascript:;" name="a_category1"></a>
                                <a href="javascript:;" name="a_category2"></a>
                                <a href="javascript:;" name="a_category3"></a>
                            </span>
                        </blockquote>
                        <blockquote class="layui-elem-quote layui-quote-nm">
                            <div class="layui-row">
                                <div class="layui-col-md4">
                                    <div class="layui-card">
                                        <div class="layui-card-header">
                                            <blockquote class="layui-elem-quote layui-quote-nm"><i class="layui-icon">&#xe62a;</i> 一级商品分类</blockquote>
                                        </div>
                                        <div class="layui-card-body">
                                            <table class="layui-table" id="showTable1" lay-filter="showTable1" lay-size="sm"></table>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md4">
                                    <div class="layui-card">
                                        <div class="layui-card-header">
                                            <blockquote class="layui-elem-quote layui-quote-nm"><i class="layui-icon">&#xe62a;</i> 二级商品分类</blockquote>
                                        </div>
                                        <div class="layui-card-body">
                                            <table class="layui-table" id="showTable2" lay-filter="showTable2" lay-size="sm"></table>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-col-md4">
                                    <div class="layui-card">
                                        <div class="layui-card-header">
                                            <blockquote class="layui-elem-quote layui-quote-nm"><i class="layui-icon">&#xe62a;</i> 三级商品分类</blockquote>
                                        </div>
                                        <div class="layui-card-body">
                                            <table class="layui-table" id="showTable3" lay-filter="showTable3" lay-size="sm"></table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </blockquote>
                        <div class="layui-form-item">
                            <button class="layui-btn layui-btn-primary layui-border-blue" lay-submit lay-filter="formStep" style="float: right;">下一步, 填写商品信息 <i class="fa fa-share"></i></button>
                        </div>
                    </form>
                </div>


                <div>
                    <form class="layui-form" style="margin: 0 auto;">
                        <blockquote class="layui-elem-quote"><i class="layui-icon">&#xe653;</i> 商品基本信息</blockquote>
                        <blockquote class="layui-elem-quote layui-quote-nm">
                            <div class="layui-form-item">
                                <table class="layui-table" lay-size="sm">
                                    <colgroup>
                                        <col width="100">
                                        <col width="500">
                                        <col width="100">
                                        <col width="500">
                                    </colgroup>
                                    <tbody>
                                    <tr>
                                        <td class="required">商品分类</td>
                                        <td colspan="3">
                                            <div class="layui-breadcrumb" lay-separator="<i class='layui-icon'>&#xe602;</i>" style="padding-top: 8px; float: left;">
                                                <a href="javascript:;" name="a_category1"></a>
                                                <a href="javascript:;" name="a_category2"></a>
                                                <a href="javascript:;" name="a_category3"></a>
                                            </div>
                                            <div style="padding-left: 20px; padding-top: 10px; float: left; cursor: pointer;">
                                                <i class="fa fa-edit" style="font-size: 14px; color: #1E9FFF;" id="editCategory">编辑</i>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="required">商品名称</td>
                                        <td><input type="text" name="name" lay-verify="required" autocomplete="off" placeholder="请输入商品名称" lay class="layui-input"/></td>
                                        <td rowspan="2">商品介绍</td>
                                        <td rowspan="2">
                                            <textarea placeholder="请输入商品介绍" class="layui-textarea"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="required">商品标题</td>
                                        <td><input type="text" name="caption" lay-verify="required" autocomplete="off" placeholder="请输入商品标题" class="layui-input"/></td>
                                    </tr>
                                    <tr>
                                        <td class="required">运营商家</td>
                                        <td>
                                            <select name="sellerId" lay-search lay-verify="required" th:with="sellerList=${@sellerService.list()}">
                                                <option value="">请选择运营商家</option>
                                                <option th:each="seller : ${sellerList}" th:text="${seller.sellerName}" th:value="${seller.id}"></option>
                                            </select>
                                        </td>
                                        <td class="required">商品品牌</td>
                                        <td>
                                            <select name="brandId" lay-search lay-verify="required" th:with="brandList=${@shopBrandService.list()}">
                                                <option value="">请选择商品品牌</option>
                                                <option th:each="brand : ${brandList}" th:text="${brand.name}" th:value="${brand.id}"></option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="required">商品状态</td>
                                        <td>
                                            <select name="isMarketable" lay-search lay-verify="required" th:with="dataResult=${@commonController.findAllGoodsStatus()}">
                                                <option th:each="map : ${dataResult.getData()}" th:text="${map.get('name')}" th:value="${map.get('id')}"></option>
                                            </select>
                                        </td>
                                        <td>运费模板</td>
                                        <td>
                                            <select name="" lay-search <!--th:with="brandList=${@shopBrandService.list()}"-->>
                                            <option value="">请选择运费模板</option>
                                            <!--<option th:each="brand : ${brandList}" th:text="${brand.name}" th:value="${brand.id}"></option>-->
                                            </select>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>


                            </div>
                        </blockquote>


                        <blockquote class="layui-elem-quote"><i class="layui-icon">&#xe653;</i> 商品库存规格</blockquote>
                        <blockquote class="layui-elem-quote layui-quote-nm">


                            <table class="layui-table" lay-size="sm">
                                <colgroup>
                                    <col width="100">
                                    <col width="1100">
                                </colgroup>
                                <tbody>
                                <tr>
                                    <td class="required">商品货号</td>
                                    <td><input type="text" name="sn" lay-verify="required|SPU_SN" autocomplete="off" placeholder="请输入商品货号" lay class="layui-input"/></td>
                                </tr>
                                <tr>
                                    <td>服务保证</td>
                                    <td>
                                        <input type="checkbox" name="like[write]" title="无忧退货" checked>
                                        <input type="checkbox" name="like[read]" title="快速退款" checked>
                                        <input type="checkbox" name="like[dai]" title="免费包邮">
                                    </td>
                                </tr>
                                </tbody>
                            </table>

                        </blockquote>


                        <div class="layui-form-item">
                            <button type="button" class="layui-btn layui-btn-primary layui-border-black pre" style="float: left;"><i class="fa fa-reply"></i> 上一步, 选择商品分类</button>
                            <button class="layui-btn layui-btn-primary layui-border-blue" lay-submit lay-filter="formStep2" style="float: right;">下一步, 填写商品属性 <i class="fa fa-share"></i></button>
                        </div>
                    </form>
                </div>


                <div>
                    <form class="layui-form" style="margin: 0 auto;">


                        <hr/>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <button type="button" class="layui-btn layui-btn-primary layui-border-black pre"><i class="fa fa-reply"></i> 上一步, 填写商品信息</button>
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn layui-btn-primary layui-border-blue"><i class="fa fa-send"></i> 提交审核</button>
                            </div>
                        </div>


                    </form>
                </div>


            </div>


        </div>

    </div>
</div>
<script type="text/html" id="toolbar1">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-primary layui-border-green layui-btn-sm" lay-event="add" shiro:hasPermission="shopCategory:add"><i class="layui-icon">&#xe61f;</i> 新增一级分类</a>
    </div>
</script>
<script type="text/html" id="toolbar2">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-primary layui-border-green layui-btn-sm" lay-event="add" shiro:hasPermission="shopCategory:add"><i class="layui-icon">&#xe61f;</i> 新增二级分类</a>
    </div>
</script>
<script type="text/html" id="toolbar3">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-primary layui-border-green layui-btn-sm" lay-event="add" shiro:hasPermission="shopCategory:add"><i class="layui-icon">&#xe61f;</i> 新增三级分类</a>
    </div>
</script>
</div>
<script th:src="@{/js/core.util.js}" charset="utf-8"></script>
<script th:src="@{/layui2.0/lib/layui-v2.6.3/layui.js}" charset="utf-8"></script>
<script th:src="@{/layui2.0/js/lay-config.js(v=2.0.0)}" charset="utf-8"></script>
</body>
</html>
<script>
    //获取token
    var token = CoreUtil.getData("access_token");
    //地址栏转义token中的#号
    var tokenQuery = token.replace("#", "%23");
    var tableIns1, tableIns2, tableIns3;
    var $ = jQuery = layui.jquery;
    layui.use(['form', 'table', 'layer', 'step', 'util'], function () {
        var form = layui.form;
        var table = layui.table;
        var layer = layui.layer;
        var step = layui.step;
        var util = layui.util;
        step.render({
            elem: '#stepForm',
            filter: 'stepForm',
            width: '100%', //设置容器宽度
            stepWidth: '800px',
            height: '800px',
            initStep: 3,// 初始化显示索引
            stepItems: [{
                title: '选择商品分类'
            }, {
                title: '填写商品信息'
            }, {
                title: '填写商品属性'
            }]
        });
        form.on('submit(formStep)', function (data) {
            var checkStatus = table.checkStatus('showTable3');
            if (checkStatus.data.length <= 0) {
                layer.msg('请选择商品分类', {icon: 5});
            } else {
                step.next('#stepForm');
            }
            return false;
        });
        form.on('submit(formStep2)', function (data) {
            step.next('#stepForm');
            return false;
        });
        $('.pre').click(function () {
            step.pre('#stepForm');
        });
        $('.next').click(function () {
            step.next('#stepForm');
        });
        // 编辑分类
        $("#editCategory").click(function () {
            step.pre('#stepForm');
        });
        //加载一级分类table
        tableIns1 = table.render({
            elem: '#showTable1'
            , contentType: 'application/json'
            , headers: {"authorization": token}
            , height: 490
            , page: true //开启分页
            , url: '/shopCategory/listByPage' //数据接口
            , where: {parentId: '0'}
            , method: 'POST'
            , parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": CoreUtil.isEmpty(res.data) ? 0 : res.data.total, //解析数据长度
                    "data": CoreUtil.isEmpty(res.data) ? null : res.data.records //解析数据列表
                }
            }
            , cols: [
                [
                    {type: 'radio'},
                    {width: 120, field: 'id', title: '分类编号', sort: true},
                    {field: 'name', title: '分类名称', edit: 'text'},
                ]
            ]
            , toolbar: '#toolbar1'
            , defaultToolbar: []
            , done: function (res, curr, count) {
                $(".layui-table-view[lay-id='showTable1'] .layui-table-body tr[data-index='0'] .layui-form-radio").click();
            }
        });
        table.on('radio(showTable1)', function (obj) { //test 是 table 标签对应的 lay-filter 属性
            $("a[name='a_category1']").html(obj.data.name);
            $("a[name='a_category2']").html("");
            $("a[name='a_category3']").html("");
            tableIns2.reload({
                    url: '/shopCategory/listByPage', //数据接口
                    where: {parentId: obj.data.id},
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                }
            );
            tableIns3.reload({
                    url: '/shopCategory/listByPage', //数据接口
                    where: {parentId: '-1'},
                }
            );
        });
        //表头工具
        table.on('toolbar(showTable1)', function (obj) {
            switch (obj.event) {
                case 'add':
                    layer.open({
                        id: 'shopCategory_add1', //设定一个id，防止重复弹出
                        title: '<i class="layui-icon">&#xe653;</i> 新增一级商品分类',
                        type: 2,
                        content: '../../index/shopCategory/addOrUpdate',
                        btn: ['提交保存', '取消'],
                        area: ['50%', '70%'],
                        scrollbar: false,
                        yes: function (index, layero) {
                            // 得到iframe页的窗口对象并调用子页面方法
                            window[layero.find('iframe')[0]['name']].saveShopCategory("submitBtnForAdd");
                        },
                        end: function () {
                            // 刷新table
                            table.reload('showTable1');
                        }
                    });
                    break;
            }
        });
        //加载二级分类table
        tableIns2 = table.render({
            elem: '#showTable2'
            , contentType: 'application/json'
            , headers: {"authorization": token}
            , height: 490
            , page: true //开启分页
            // , url: '/shopCategory/listByPage' //数据接口
            // , where: {parentId: '-1'}
            , method: 'POST'
            , parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": CoreUtil.isEmpty(res.data) ? 0 : res.data.total, //解析数据长度
                    "data": CoreUtil.isEmpty(res.data) ? null : res.data.records //解析数据列表
                }
            }
            , cols: [
                [
                    {type: 'radio'},
                    {width: 120, field: 'id', title: '分类编号', sort: true},
                    {field: 'name', title: '分类名称', edit: 'text'},
                ]
            ]
            , data: []
            , toolbar: '#toolbar2'
            , defaultToolbar: []
            , done: function (res, curr, count) {
                $(".layui-table-view[lay-id='showTable2'] .layui-table-body tr[data-index='0'] .layui-form-radio").click();
            }
        });
        table.on('radio(showTable2)', function (obj) { //test 是 table 标签对应的 lay-filter 属性
            $("a[name='a_category2']").html(obj.data.name);
            $("a[name='a_category3']").html("");
            tableIns3.reload({
                    url: '/shopCategory/listByPage', //数据接口
                    where: {parentId: obj.data.id},
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                }
            );
        });
        //表头工具
        table.on('toolbar(showTable2)', function (obj) {
            switch (obj.event) {
                case 'add':
                    // 已选中一级分类
                    var checkStatus = table.checkStatus('showTable1');
                    layer.open({
                        id: 'shopCategory_add2', //设定一个id，防止重复弹出
                        title: '<i class="layui-icon">&#xe653;</i> 新增二级商品分类',
                        type: 2,
                        content: '../../index/shopCategory/addOrUpdate2',
                        btn: ['提交保存', '取消'],
                        area: ['50%', '70%'],
                        scrollbar: false,
                        yes: function (index, layero) {
                            // 得到iframe页的窗口对象并调用子页面方法
                            window[layero.find('iframe')[0]['name']].saveShopCategory("submitBtnForAdd");
                        },
                        end: function () {
                            // 刷新table
                            table.reload('showTable2');
                        },
                        success: function (layero, index) {
                            // 得到iframe页的窗口对象并调用子页面方法
                            var subordinateData = {};
                            subordinateData.parentId = checkStatus.data[0].id;
                            subordinateData.templateId = checkStatus.data[0].templateId;
                            subordinateData.isShow = 1;
                            subordinateData.isMenu = 1;
                            window[layero.find('iframe')[0]['name']].assignment(subordinateData);
                        }
                    });
                    break;
            }
        });
        //加载三级分类table
        tableIns3 = table.render({
            elem: '#showTable3'
            , contentType: 'application/json'
            , headers: {"authorization": token}
            , height: 490
            , page: true //开启分页
            // , url: '/shopCategory/listByPage' //数据接口
            // , where: {parentId: '-1'}
            , method: 'POST'
            , parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": CoreUtil.isEmpty(res.data) ? 0 : res.data.total, //解析数据长度
                    "data": CoreUtil.isEmpty(res.data) ? null : res.data.records //解析数据列表
                }
            }
            , cols: [
                [
                    {type: 'radio'},
                    {width: 120, field: 'id', title: '分类编号', sort: true},
                    {field: 'name', title: '分类名称', edit: 'text'},
                ]
            ]
            , data: []
            , toolbar: '#toolbar3'
            , defaultToolbar: []
            , done: function (res, curr, count) {
                $(".layui-table-view[lay-id='showTable3'] .layui-table-body tr[data-index='0'] .layui-form-radio").click();
            }
        });
        table.on('radio(showTable3)', function (obj) { //test 是 table 标签对应的 lay-filter 属性
            $("a[name='a_category3']").html(obj.data.name);
        });
        //表头工具
        table.on('toolbar(showTable3)', function (obj) {
            switch (obj.event) {
                case 'add':
                    // 已选中二级分类
                    var checkStatus = table.checkStatus('showTable2');
                    layer.open({
                        id: 'shopCategory_add3', //设定一个id，防止重复弹出
                        title: '<i class="layui-icon">&#xe653;</i> 新增三级商品分类',
                        type: 2,
                        content: '../../index/shopCategory/addOrUpdate3/' + checkStatus.data[0].parentId,
                        btn: ['提交保存', '取消'],
                        area: ['70%', '70%'],
                        scrollbar: false,
                        yes: function (index, layero) {
                            // 得到iframe页的窗口对象并调用子页面方法
                            window[layero.find('iframe')[0]['name']].saveShopCategory("submitBtnForAdd");
                        },
                        end: function () {
                            // 刷新table
                            table.reload('showTable3');
                        },
                        success: function (layero, index) {
                            // 得到iframe页的窗口对象并调用子页面方法
                            var subordinateData = {};
                            subordinateData.parentId = checkStatus.data[0].id;
                            subordinateData.grandParentId = checkStatus.data[0].parentId;
                            subordinateData.templateId = checkStatus.data[0].templateId;
                            subordinateData.isShow = 1;
                            subordinateData.isMenu = 1;
                            window[layero.find('iframe')[0]['name']].assignment(subordinateData);
                        }
                    });
                    break;
            }
        });
        /**
         * 监听单元格编辑
         */
        table.on('edit(showTable1)', function (obj) {
            var value = obj.value //得到修改后的值
                , data = obj.data //得到所在行所有键值
                , field = obj.field; //得到字段
            var shopCategory = {};
            shopCategory.id = data.id;
            shopCategory[field] = util.escape(value);
            CoreUtil.sendPut("/shopCategory/update", shopCategory, function (res) {
                layer.msg(res.msg);
            });
        });
        /**
         * 监听单元格编辑
         */
        table.on('edit(showTable2)', function (obj) {
            var value = obj.value //得到修改后的值
                , data = obj.data //得到所在行所有键值
                , field = obj.field; //得到字段
            var shopCategory = {};
            shopCategory.id = data.id;
            shopCategory[field] = util.escape(value);
            CoreUtil.sendPut("/shopCategory/update", shopCategory, function (res) {
                layer.msg(res.msg);
            });
        });
        /**
         * 监听单元格编辑
         */
        table.on('edit(showTable3)', function (obj) {
            var value = obj.value //得到修改后的值
                , data = obj.data //得到所在行所有键值
                , field = obj.field; //得到字段
            var shopCategory = {};
            shopCategory.id = data.id;
            shopCategory[field] = util.escape(value);
            CoreUtil.sendPut("/shopCategory/update", shopCategory, function (res) {
                layer.msg(res.msg);
            });
        });
        /**
         * 自定义表单验证
         */
        form.verify({
            'SPU_SN': function (value, item) {
                var checkResult = 'SPU商品货号已存在';
                CoreUtil.sendSyncPut("/goods/findOneByUnique/" + value.trim(), null, function (res) {
                    if(!res.data){
                        checkResult = '';
                    }
                });
                return checkResult
            }
        })
    });

</script>
